{{!-- Giao di·ªán ch·ªânh s·ª≠a video --}}
<div class="container-fluid mt-3">
    {{!-- ƒê√£ x√≥a n√∫t tho√°t kh·∫©n c·∫•p --}}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="back-to-edit-btn" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay L·∫°i
        </button>
        <h1 class="text-center m-0">Ch·ªânh S·ª≠a Video</h1>
        <div style="width: 100px;"></div> <!-- Ph·∫ßn t·ª≠ r·ªóng ƒë·ªÉ c√¢n b·∫±ng layout -->
    </div>

    <div class="row">
        <!-- Khu v·ª±c xem tr∆∞·ªõc -->
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Xem Tr∆∞·ªõc</h3>
                    <div>
                        <button id="play-preview-btn" class="btn btn-sm btn-light">
                            <i class="bi bi-play-fill"></i> Ph√°t
                        </button>
                        <button id="export-video-btn" class="btn btn-sm btn-success">
                            <i class="bi bi-download"></i> Xu·∫•t Video
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="preview-container" class="position-relative" style="height: 0; padding-bottom: 56.25%;">
                        <!-- L·ªõp ph·ª• tr·ª£ ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ n·ªôi dung hi·ªÉn th·ªã khi g·∫∑p l·ªói -->
                        <div id="preview-fallback" class="w-100 h-100 position-absolute"
                            style="top: 0; left: 0; background: #000; z-index: 0;">
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <div class="text-center text-muted">
                                    <p>ƒêang t·∫£i preview...</p>
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Canvas xem tr∆∞·ªõc - chuy·ªÉn ra kh·ªèi absolute -->
                        <canvas id="preview-canvas" class="position-absolute" style="top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></canvas>
                        
                        <!-- L·ªõp ph·ªß ·∫£nh s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        <div id="image-overlays-container" class="position-absolute" style="top: 0; left: 0; width: 100%; height: 100%; background: transparent !important; background-color: transparent !important; pointer-events: none; z-index: 4; mix-blend-mode: normal; backdrop-filter: none;"></div>
                        
                        <!-- L·ªõp ph·ªß ch·ªØ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        <div id="text-overlays-container" class="position-absolute"
                            style="top: 0; left: 0; width: 100%; height: 100%; background: transparent !important; background-color: transparent !important; pointer-events: none; z-index: 5; mix-blend-mode: normal; backdrop-filter: none;">
                        </div>
                    </div>
                </div>
                <!-- Thanh ƒëi·ªÅu khi·ªÉn ph√°t ƒë∆∞·ª£c di chuy·ªÉn l√™n ƒë√¢y -->
                <div class="bg-dark d-flex justify-content-between align-items-center py-1 px-2" style="display: none !important;">
                    <span class="text-light" id="timeline-current-time">00:00.000</span>
                    <div>
                        <input type="range" id="timeline-seek" class="form-range mx-2 d-inline-block"
                            style="width: 200px;" min="0" max="100" value="0">
                    </div>
                    <span class="text-light" id="timeline-duration">00:00.000</span>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card mb-3">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">Timeline</h3>
                </div>
                <div class="card-body p-0">
                    <div id="timeline-container" class="p-2">
                        <div style="display: none !important;" class="d-flex align-items-center mb-2">
                            <button id="timeline-zoom-out" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <div class="timeline-ruler flex-grow-1 position-relative" id="timeline-ruler">
                                <!-- C√°c ƒë√°nh d·∫•u th·ªùi gian s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                            </div>
                            <button id="timeline-zoom-in" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                        </div>

                        <div id="timeline-tracks" class="timeline-tracks">
                            <!-- C√°c track s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                        </div>

                        <div id="timeline-playhead" class="timeline-playhead"
                            style="width: 2px; background-color: red; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 200;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Khu v·ª±c c√¥ng c·ª• ch·ªânh s·ª≠a -->
        <div class="col-md-4">
            <!-- Tab ƒëi·ªÅu khi·ªÉn -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="editorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="clips-tab" data-bs-toggle="tab"
                                data-bs-target="#clips-panel" type="button" role="tab" aria-controls="clips-panel"
                                aria-selected="true">Clips</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-panel"
                                type="button" role="tab" aria-controls="text-panel" aria-selected="false">Ch·ªØ</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images-panel" type="button" role="tab" aria-controls="images-panel" aria-selected="false">·∫¢nh/GIF</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="effects-tab" data-bs-toggle="tab" data-bs-target="#effects-panel" type="button" role="tab" aria-controls="effects-panel" aria-selected="false">Hi·ªáu ·ª®ng</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="music-tab" data-bs-toggle="tab" data-bs-target="#music-panel"
                                type="button" role="tab" aria-controls="music-panel" aria-selected="false">Nh·∫°c
                                N·ªÅn</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="editorTabsContent">
                        <!-- Tab Clips -->
                        <div class="tab-pane fade show active" id="clips-panel" role="tabpanel"
                            aria-labelledby="clips-tab">
                            <h4>Danh S√°ch Clips</h4>
                            <div id="clips-list" class="list-group">
                                <!-- Danh s√°ch clips s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                            </div>
                            <div class="mt-3">
                                <h5>Ch·ªânh S·ª≠a Clip</h5>
                                <div id="clip-editor" class="d-none">
                                    <div class="mb-2">
                                        <label class="form-label">Th·ªùi L∆∞·ª£ng (gi√¢y)</label>
                                        <input type="number" id="clip-duration" class="form-control" min="0.5"
                                            step="0.5" value="3">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">ƒêi·ªÉm B·∫Øt ƒê·∫ßu (gi√¢y)</label>
                                        <input type="number" id="clip-start-time" class="form-control" min="0"
                                            step="0.1" value="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Chuy·ªÉn C·∫£nh</label>
                                        <select id="clip-transition" class="form-select">
                                            <option value="none">Kh√¥ng c√≥</option>
                                            <option value="fade">M·ªù d·∫ßn</option>
                                            <option value="slide">Tr∆∞·ª£t</option>
                                            <option value="zoom">Ph√≥ng to</option>
                                        </select>
                                    </div>
                                    <button id="apply-clip-changes" class="btn btn-primary mt-2">√Åp D·ª•ng Thay
                                        ƒê·ªïi</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Text -->
                        <div class="tab-pane fade" id="text-panel" role="tabpanel" aria-labelledby="text-tab">
                            <div class="d-flex justify-content-between mb-3">
                                <h4>VƒÉn B·∫£n</h4>
                                <button id="add-text-btn" class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus"></i> Th√™m Ch·ªØ
                                </button>
                            </div>

                            <div id="text-items-list" class="list-group mb-3">
                                <!-- Danh s√°ch vƒÉn b·∫£n s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                            </div>

                            <div id="text-editor" class="d-none">
                                <h5>Ch·ªânh S·ª≠a VƒÉn B·∫£n</h5>
                                <div class="mb-2">
                                    <label class="form-label">N·ªôi Dung</label>
                                    <textarea id="text-content" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Font</label>
                                    <select id="text-font" class="form-select">
                                        <option value="Arial">Arial</option>
                                        <option value="Helvetica">Helvetica</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Verdana">Verdana</option>
                                    </select>
                                </div>
                                <div class="row mb-2">
                                    <div class="col">
                                        <label class="form-label">K√≠ch Th∆∞·ªõc</label>
                                        <input type="number" id="text-size" class="form-control" min="8" max="72"
                                            value="24">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">M√†u S·∫Øc</label>
                                        <input type="color" id="text-color" class="form-control form-control-color"
                                            value="#ffffff">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">V·ªã Tr√≠</label>
                                    <select id="text-position" class="form-select">
                                        <option value="top">Tr√™n</option>
                                        <option value="middle" selected>Gi·ªØa</option>
                                        <option value="bottom">D∆∞·ªõi</option>
                                    </select>
                                </div>
                                <div class="row mb-2">
                                    <div class="col">
                                        <label class="form-label">Th·ªùi ƒêi·ªÉm B·∫Øt ƒê·∫ßu (gi√¢y)</label>
                                        <input type="number" id="text-start-time" class="form-control" min="0"
                                            step="0.1" value="0">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">Th·ªùi L∆∞·ª£ng (gi√¢y)</label>
                                        <input type="number" id="text-duration" class="form-control" min="0.5"
                                            step="0.5" value="3">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="text-animation">
                                        <label class="form-check-label" for="text-animation">
                                            Hi·ªáu ·ª®ng Xu·∫•t Hi·ªán
                                        </label>
                                    </div>
                                </div>
                                <button id="apply-text-changes" class="btn btn-primary">√Åp D·ª•ng Thay ƒê·ªïi</button>
                                <button id="delete-text-item" class="btn btn-danger">X√≥a</button>
                            </div>
                        </div>
                        
                        <!-- Tab Images -->
                        <div class="tab-pane fade" id="images-panel" role="tabpanel" aria-labelledby="images-tab">
                            <div class="d-flex justify-content-between mb-3">
                                <h4>Danh S√°ch ·∫¢nh/GIF</h4>
                                <button id="add-image-btn" class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus"></i> Th√™m ·∫¢nh
                                </button>
                            </div>
                            
                            <div id="image-items-list" class="list-group mb-3">
                                <!-- Danh s√°ch ·∫£nh/GIF s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                            </div>
                            
                            <div id="image-editor" class="d-none">
                                <h5>Ch·ªânh S·ª≠a ·∫¢nh/GIF</h5>
                                
                                <div class="row mb-2">
                                    <div class="col">
                                        <label class="form-label">Th·ªùi ƒêi·ªÉm B·∫Øt ƒê·∫ßu (gi√¢y)</label>
                                        <input type="number" id="image-start-time" class="form-control" min="0" step="0.1" value="0">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">Th·ªùi L∆∞·ª£ng (gi√¢y)</label>
                                        <input type="number" id="image-duration" class="form-control" min="0.5" step="0.5" value="3">
                                    </div>
                                </div>
                                
                                <div class="row mb-2">
                                    <div class="col">
                                        <label class="form-label">ƒê·ªô M·ªù</label>
                                        <input type="range" id="image-opacity" class="form-range" min="0" max="100" value="100">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">T·ªâ L·ªá</label>
                                        <input type="range" id="image-scale" class="form-range" min="50" max="200" value="100">
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label">G√≥c Xoay</label>
                                    <input type="range" id="image-rotation" class="form-range" min="0" max="359" value="0">
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label">Hi·ªáu ·ª®ng</label>
                                    <select id="image-animation" class="form-select">
                                        <option value="none">Kh√¥ng c√≥</option>
                                        <option value="fade">M·ªù d·∫ßn</option>
                                        <option value="zoom-in">Ph√≥ng to</option>
                                        <option value="zoom-out">Thu nh·ªè</option>
                                        <option value="slide-left">Tr∆∞·ª£t t·ª´ ph·∫£i sang</option>
                                        <option value="slide-right">Tr∆∞·ª£t t·ª´ tr√°i sang</option>
                                    </select>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <button id="apply-image-changes" class="btn btn-primary">√Åp D·ª•ng Thay ƒê·ªïi</button>
                                    <button id="delete-image-item" class="btn btn-danger">X√≥a</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Effects -->
                        <div class="tab-pane fade" id="effects-panel" role="tabpanel" aria-labelledby="effects-tab">
                            <h4>Hi·ªáu ·ª®ng</h4>
                            <div class="list-group">
                                <button class="list-group-item list-group-item-action" data-effect="none">Kh√¥ng c√≥ hi·ªáu
                                    ·ª©ng</button>
                                <button class="list-group-item list-group-item-action" data-effect="grayscale">ƒêen
                                    Tr·∫Øng</button>
                                <button class="list-group-item list-group-item-action"
                                    data-effect="sepia">Sepia</button>
                                <button class="list-group-item list-group-item-action" data-effect="brightness">TƒÉng
                                    S√°ng</button>
                                <button class="list-group-item list-group-item-action" data-effect="contrast">TƒÉng T∆∞∆°ng
                                    Ph·∫£n</button>
                                <button class="list-group-item list-group-item-action" data-effect="blur">L√†m
                                    M·ªù</button>
                            </div>

                            <div class="mt-3" id="effect-settings" style="display: none;">
                                <h5>Thi·∫øt L·∫≠p Hi·ªáu ·ª®ng</h5>
                                <div class="mb-2">
                                    <label id="effect-value-label" class="form-label">Gi√° Tr·ªã</label>
                                    <input type="range" id="effect-value" class="form-range" min="0" max="100"
                                        value="50">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">√Åp D·ª•ng Cho</label>
                                    <select id="effect-target" class="form-select">
                                        <option value="selected">Clip ƒêang Ch·ªçn</option>
                                        <option value="all">To√†n B·ªô Video</option>
                                    </select>
                                </div>
                                <button id="apply-effect" class="btn btn-primary mt-2">√Åp D·ª•ng Hi·ªáu ·ª®ng</button>
                            </div>
                        </div>
                        <!-- Tab Music Nh·∫°c n·ªÅn-->
                        <div class="tab-pane fade" id="music-panel" role="tabpanel" aria-labelledby="music-tab">
                            <h4>Nh·∫°c N·ªÅn</h4>
                            <div class="mb-3">
                                <label for="bg-music-select" class="form-label">Ch·ªçn nh·∫°c n·ªÅn</label>
                                <select id="bg-music-select" class="form-select">
                                    <option value="">-- Kh√¥ng nh·∫°c n·ªÅn --</option>
                                    <option value="calm.mp3">Calm</option>
                                    <option value="epic.mp3">Epic</option>
                                    <option value="lofi.mp3">Lo-fi</option>
                                    <option value="CanYouSee.mp3">CanYouSee</option>
                                    <option value="DoanTuyetNangDiRemix.mp3">DoanTuyetNangDiRemix</option>
                                    <option value="Kh√¥ngƒêauN·ªØaR·ªìi.mp3">Kh√¥ngƒêauN·ªØaR·ªìi</option>
                                    <option value="NhacLienQuan.mp3">NhacLienQuan</option>
                                </select>

                                <!-- N√∫t nghe th·ª≠ v√† d·ª´ng -->
                                <div class="mt-2 d-flex gap-2">
                                    <button id="preview-music-btn" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-music-note-beamed"></i> Nghe Th·ª≠
                                    </button>
                                    <button id="stop-music-btn" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-stop-circle"></i> D·ª´ng
                                    </button>
                                </div>
                            </div>

                            <!-- ƒêi·ªÅu ch·ªânh √¢m l∆∞·ª£ng -->
                            <div class="mb-3">
                                <label for="bg-music-volume" class="form-label">√Çm l∆∞·ª£ng</label>
                                <input type="range" class="form-range" id="bg-music-volume" min="0" max="1" step="0.01"
                                    value="0.5">
                                <div class="form-text">Ch·ªânh √¢m l∆∞·ª£ng nh·∫°c n·ªÅn khi xu·∫•t video.</div>
                            </div>

                            <!-- Ch·ªçn ƒëi·ªÉm b·∫Øt ƒë·∫ßu nh·∫°c -->
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label">T·ª´</label>
                                        <input type="number" class="form-control" id="music-start-time" value="0"
                                            min="0" step="1">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">ƒê·∫øn</label>
                                        <input type="number" class="form-control" id="music-end-time" value="60" min="0"
                                            step="1">
                                    </div>
                                    <div class="col d-flex align-items-end">
                                        <span class="form-text">gi√¢y</span>
                                    </div>
                                    <div class="mt-2">
                                        <button id="confirm-music-range-btn" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-check2-circle"></i> X√°c nh·∫≠n ƒëo·∫°n nh·∫°c
                                        </button>
                                    </div>
                                </div>
                                <small class="form-text">ƒêo·∫°n nh·∫°c s·∫Ω ƒë∆∞·ª£c c·∫Øt v√† ch√®n v√†o video khi xu·∫•t.</small>
                            </div>

                            <!-- Preview -->
                            <div class="mb-3">
                                <audio id="bg-music-preview" controls class="w-100" style="display: none;"></audio>
                            </div>
                        </div> <!-- ƒê√≥ng music-panel -->

                        <!-- Modal th√™m vƒÉn b·∫£n -->
                        <div class="modal fade" id="textModal" tabindex="-1" aria-labelledby="textModalLabel"
                            aria-hidden="true" data-bs-backdrop="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="textModalLabel">Th√™m VƒÉn B·∫£n</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="new-text-content" class="form-label">N·ªôi Dung</label>
                                            <textarea id="new-text-content" class="form-control" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">V·ªã Tr√≠</label>
                                            <select id="new-text-position" class="form-select">
                                                <option value="top">Tr√™n</option>
                                                <option value="middle" selected>Gi·ªØa</option>
                                                <option value="bottom">D∆∞·ªõi</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">H·ªßy</button>
                                        <button type="button" class="btn btn-primary"
                                            id="confirm-add-text">Th√™m</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- ƒê√≥ng tab-content -->
                </div> <!-- ƒê√≥ng card-body -->
            </div> <!-- ƒê√≥ng card -->
        </div> <!-- ƒê√≥ng col-md-4 -->
    </div> <!-- ƒê√≥ng row -->
</div> <!-- ƒê√≥ng container-fluid -->

<!-- Modal th√™m ·∫£nh -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true" data-bs-backdrop="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Th√™m ·∫¢nh/GIF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-image-url" class="form-label">URL ·∫¢nh/GIF</label>
                    <input type="text" id="new-image-url" class="form-control" placeholder="Nh·∫≠p URL ·∫£nh ho·∫∑c GIF...">
                    <small class="text-muted">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng JPG, PNG, GIF</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ho·∫∑c ch·ªçn t·ª´ m√°y t√≠nh</label>
                    <input type="file" id="image-upload" class="form-control" accept="image/*,.gif">
                    <small class="text-muted">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng JPG, PNG, GIF (t·ªëi ƒëa 5MB)</small>
                </div>
                <div class="mb-3">
                    <label for="new-image-name" class="form-label">T√™n (T√πy ch·ªçn)</label>
                    <input type="text" id="new-image-name" class="form-control" placeholder="Nh·∫≠p t√™n cho ·∫£nh...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirm-add-image" data-bs-dismiss="modal">Th√™m</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<link rel="stylesheet" href="/js/videoEditor/videoEditor.css">

<!-- Load c√°c th√†nh ph·∫ßn c∆° b·∫£n -->
<script src="/js/videoEditor/timeline.js"></script>
<script src="/js/videoEditor/textOverlay.js"></script>
<script src="/js/videoEditor/imageOverlay.js"></script>
<script src="/js/videoEditor/effectsManager.js"></script>
<script src="/js/videoEditor/MediaLoader.js"></script>
<script src="/js/videoEditor/PreviewManager.js"></script>
<script src="/js/videoEditor/VideoDataConverter.js"></script>
<script src="/js/videoEditor/ExportManager.js"></script>
<script src="/js/videoEditor/VideoEditorCore.js"></script>
<script src="/js/videoEditor/videoEditor.js"></script>
<script src="/js/videoEditor/renderFix.js"></script>

<!-- Script ƒë·ªÉ ƒë·∫£m b·∫£o modal kh√¥ng l√†m t·ªëi m√†n h√¨nh sau khi ƒë√≥ng -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textModal = document.getElementById('textModal');
    if (textModal) {
        textModal.addEventListener('hidden.bs.modal', function () {
            // X√≥a l·ªõp modal-backdrop kh·ªèi body n·∫øu c√≤n s√≥t l·∫°i
            const modalBackdrops = document.querySelectorAll('.modal-backdrop');
            modalBackdrops.forEach(backdrop => {
                backdrop.remove();
            });
            
            // X√≥a c√°c class v√† style tr√™n body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });
    }
    
    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
        imageModal.addEventListener('hidden.bs.modal', function () {
            const modalBackdrops = document.querySelectorAll('.modal-backdrop');
            modalBackdrops.forEach(backdrop => {
                backdrop.remove();
            });
            
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });
    }
    
    // X·ª≠ l√Ω ·∫©n/hi·ªán ph·∫ßn v·ªã tr√≠ t√πy ch·ªânh khi chuy·ªÉn tab
    const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabEls.forEach(tabEl => {
        tabEl.addEventListener('shown.bs.tab', function (e) {
            const customPositionEl = document.getElementById('text-position-custom');
            if (customPositionEl) {
                if (e.target.id === 'text-tab') {
                    customPositionEl.style.display = 'block';
                } else {
                    customPositionEl.style.display = 'none';
                }
            }
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 0) Thi·∫øt l·∫≠p aspect ratio cho preview v√† payload ---
  const aspectRatio = sessionStorage.getItem('videoAspectRatio') || '16:9';
  const [arW, arH] = aspectRatio.split(':').map(n => parseFloat(n));
  // G√°n padding-bottom = H/W * 100% ƒë·ªÉ gi·ªØ ƒë√∫ng t·ªâ l·ªá
  const previewContainer = document.getElementById('preview-container');
  if (previewContainer && arW && arH) {
    previewContainer.style.paddingBottom = (arH / arW * 100) + '%';
  }

  // --- 1) Modal cleanup (gi·ªØ nguy√™n) ---
  ['textModal','imageModal'].forEach(id => {
    const m = document.getElementById(id);
    if (!m) return;
    m.addEventListener('hidden.bs.modal', () => {
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    });
  });

  // --- 2) Music preview setup (gi·ªØ nguy√™n) ---
  const sel          = document.getElementById('bg-music-select');
  const volEl        = document.getElementById('bg-music-volume');
  const previewAudio = document.getElementById('bg-music-preview');
  const btnPlayA     = document.getElementById('preview-music-btn');
  const btnStopA     = document.getElementById('stop-music-btn');
  const startEl      = document.getElementById('music-start-time');
  const endEl        = document.getElementById('music-end-time');
  const btnConfirmM  = document.getElementById('confirm-music-range-btn');

  sel?.addEventListener('change', () => {
    if (!sel.value) {
      previewAudio.pause();
      previewAudio.src = '';
      previewAudio.style.display = 'none';
    } else {
      previewAudio.src = `/music/${sel.value}`;
      previewAudio.volume = parseFloat(volEl.value);
      previewAudio.style.display = 'block';
      previewAudio.currentTime = window.musicRangeStart || 0;
    }
  });
  btnPlayA?.addEventListener('click', () => sel.value && previewAudio.play());
  btnStopA?.addEventListener('click', () => { previewAudio.pause(); previewAudio.currentTime = 0; });
  volEl?.addEventListener('input', () => previewAudio.volume = parseFloat(volEl.value));
  btnConfirmM?.addEventListener('click', () => {
    window.musicRangeStart = parseFloat(startEl.value) || 0;
    window.musicRangeEnd   = parseFloat(endEl.value)   || null;
    if (sel.value) {
      previewAudio.currentTime = window.musicRangeStart;
      previewAudio.play();
      const stopAt = () => {
        if (window.musicRangeEnd != null && previewAudio.currentTime >= window.musicRangeEnd) {
          previewAudio.pause();
          previewAudio.removeEventListener('timeupdate', stopAt);
        }
      };
      previewAudio.addEventListener('timeupdate', stopAt);
    }
  });

  // --- 3) Helper client: gatherClips(), gatherText(), gatherImage() ---
  function gatherClips() {
    const raw = window.timeline?.getClips?.() || window.timeline?.clips || [];
    return raw.map(c => ({
      partId:    c.partId    ?? c.id,
      imagePath: c.imagePath ?? c.src,
      audioPath: c.audioPath ?? c.audioSrc,
      startTime: Number.isFinite(c.startTime) ? c.startTime : (c.start ?? 0),
      duration:  Number.isFinite(c.duration)  ? c.duration  : (c.length ?? 0),
      effect:    c.effect   ?? null,
      transition:c.transition?? null
    }));
  }
  function gatherText() {
    const raw = window.textOverlay?.getAll?.() || [];
    return raw.map(t => ({
      content:   t.content ?? t.text        ?? '',
      color:     t.color   ?? t.fillStyle   ?? 'white',
      size:      t.size    ?? t.fontSize    ?? 24,
      x:         Number.isFinite(t.x)       ? t.x           : (t.xNorm ?? 0.5),
      y:         Number.isFinite(t.y)       ? t.y           : (t.yNorm ?? 0.5),
      startTime: Number.isFinite(t.startTime)? t.startTime  : (t.start  ?? 0),
      duration:  Number.isFinite(t.duration) ? t.duration   : (t.length ?? 3)
    }));
  }
  function gatherImage() {
    const raw = window.imageOverlay?.getAll?.() || [];
    return raw.map(o => ({
      src:       o.src       ?? o.imagePath     ?? '',
      opacity:   Number.isFinite(o.opacity)   ? o.opacity     : ((o.alpha||1)*100),
      scaleW:    Number.isFinite(o.scaleW)    ? o.scaleW      : (o.widthNorm ?? 1),
      scaleH:    Number.isFinite(o.scaleH)    ? o.scaleH      : (o.heightNorm?? 1),
      rotation:  o.rotation  ?? 0,
      x:         Number.isFinite(o.x)         ? o.x           : (o.xNorm   ?? 0.5),
      y:         Number.isFinite(o.y)         ? o.y           : (o.yNorm   ?? 0.5),
      startTime: Number.isFinite(o.startTime)? o.startTime  : (o.start   ?? 0),
      duration:  Number.isFinite(o.duration) ? o.duration   : (o.length  ?? 3)
    }));
  }

  // --- 4) Poll cho t·ªõi khi timeline/textOverlay/imageOverlay/PreviewManager s·∫µn s√†ng ---
  const iv = setInterval(() => {
    if (window.timeline && window.textOverlay && window.imageOverlay && window.PreviewManager) {
      clearInterval(iv);

      // bind Play Preview
      document.getElementById('play-preview-btn')
        .addEventListener('click', () => window.PreviewManager.playPreview());

      // bind Export Video (g·ª≠i c·∫£ aspectRatio)
      document.getElementById('export-video-btn')
        .addEventListener('click', async () => {
          try {
            const clips         = gatherClips();
            const textOverlays  = gatherText();
            const imageOverlays = gatherImage();
            const music = {
              file:   sel.value ? `/music/${sel.value}` : null,
              volume: parseFloat(volEl.value)||0.5,
              start:  window.musicRangeStart||0,
              end:    window.musicRangeEnd  ||null
            };
            const payload = {
              sessionId:    sessionStorage.getItem('videoSessionId'),
              clips, textOverlays, imageOverlays, music,
              aspectRatio  // truy·ªÅn t·ªâ l·ªá ƒë·ªông
            };

            const res = await fetch('/advanced-video/create-edited-video', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(await res.text());
            const { videoUrl } = await res.json();
            alert('üéâ Video ƒë√£ t·∫°o: ' + videoUrl);
            window.open(videoUrl,'_blank');
          } catch (err) {
            alert('Xu·∫•t video l·ªói: ' + err.message);
          }
        });
    }
  }, 100);
});
</script>
