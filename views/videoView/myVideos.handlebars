{{!-- views/videoView/myVideos.handlebars --}}
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"/>

<style>
/* ======= M√ÄU ‚Äì FONT ======= */
body{background:#0f1720;color:#e8e8e8;min-height:100vh}
.badge-size{font-size:.75rem;padding:.35em .6em;border-radius:.5rem}
.btn-outline-sky   {color:#0dcaf0;border-color:#0dcaf0}
.btn-outline-sky:hover{background:#0dcaf0;color:#fff}
.btn-outline-danger{color:#ff6b6b;border-color:#ff6b6b}
.btn-outline-danger:hover{background:#ff6b6b;color:#fff}

/* ======= CARD ======= */
.video-card{border:0;border-radius:.75rem;overflow:hidden;background:#111722;
            transition:transform .2s}
.video-card:hover{transform:translateY(-4px)}
.video-card .card-body{background:#0e1118}

/* thumbnail */
.video-thumb{position:relative;display:block;width:100%;aspect-ratio:16/9}
.video-thumb video{width:100%;height:100%;object-fit:cover}
.play-overlay{position:absolute;inset:0;display:flex;align-items:center;
              justify-content:center;font-size:3.2rem;color:#fff;
              background:rgba(0,0,0,.35);opacity:0;transition:.25s}
.video-thumb:hover .play-overlay{opacity:1}
</style>

<div class="container py-5">
  <h2 class="text-center mb-4 text-warning">üìÅ Video c·ªßa b·∫°n</h2>

  {{#if videos.length}}
  <div class="row g-4">
    {{#each videos}}
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="video-card shadow-sm h-100 d-flex flex-column">
    
        {{!-- thumbnail + n√∫t play --}}
        <a href="{{public_url}}" target="_blank" class="video-thumb flex-shrink-0">
          <video src="{{public_url}}#t=0.25" muted playsinline loop></video>
          <span class="play-overlay"><i class="bi bi-play-circle-fill"></i></span>
        </a>
    
        {{!-- info + n√∫t --}}
        <div class="card-body d-flex flex-column">
          <h6 class="mb-2 text-truncate" title="{{title}}">{{title}}</h6>
    
          <span class="badge bg-primary-subtle text-primary-emphasis badge-size mb-2">
            {{size_mb}} MB
          </span>
    
          <div class="d-flex flex-column gap-2 mt-auto">
            {{!-- N√∫t YouTube --}}
            {{#if youtube_id}}
              <button class="btn btn-sm btn-secondary w-100 mt-2" disabled title="Video ƒë√£ ƒë∆∞·ª£c upload l√™n YouTube">
                <i class="bi bi-check-circle-fill me-1"></i> ƒê√£ upload
              </button>
            {{else}}
              <button class="btn btn-sm btn-outline-sky w-100 btn-youtube"
                      title="Up video n√†y l√™n YouTube"
                      data-id="{{id}}"
                      data-url="{{local_path}}"
                      data-title="{{title}}">
                <i class="bi bi-youtube me-1"></i> YouTube
              </button>
            {{/if}}

            {{!-- N√∫t Xo√° --}}
            <button class="btn btn-sm btn-outline-danger w-100 btn-del"
                    title="Xo√° video n√†y"
                    data-id="{{id}}">
              <i class="bi bi-trash me-1"></i> Xo√°
            </button>
          </div>
        </div>
      </div>
    </div>
    {{/each}}
  </div>

  {{!-- ============= PAGINATION ============== --}}
  <nav class="mt-5 d-flex justify-content-center">
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
        <a class="page-link" href="?page={{prevPage}}">&laquo;</a>
      </li>

      {{#each pages}}
        {{#if (or (lte this 2) (gte this ../lastPageMinus1) (between this ../pageMinus1 ../pagePlus1))}}
          <li class="page-item {{#if (eq ../page this)}}active{{/if}}">
            <a class="page-link" href="?page={{this}}">{{this}}</a>
          </li>
        {{else}}
          {{#unless (lookup ../_ellipsis this)}}
            {{set ../_ellipsis this true}}
            <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
          {{/unless}}
        {{/if}}
      {{/each}}

      <li class="page-item {{#if (eq page lastPage)}}disabled{{/if}}">
        <a class="page-link" href="?page={{nextPage}}">&raquo;</a>
      </li>
    </ul>
  </nav>

  {{else}}
    <p class="text-center fs-5 text-muted">B·∫°n ch∆∞a t·∫°o video n√†o.</p>
  {{/if}}
</div>

{{!-- ========= MODAL X√ÅC NH·∫¨N XO√Å ========= --}}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-trash-fill text-danger me-2"></i>Xo√° video?
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        B·∫°n c√≥ ch·∫Øc mu·ªën xo√°&nbsp;<strong id="del-video-title"></strong>?
        <br><small class="text-danger">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</small>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
        <button class="btn btn-danger" id="confirm-delete-btn">
          <i class="bi bi-trash"></i> Xo√°
        </button>
      </div>
    </div>
  </div>
</div>

{{!-- ========= MODAL X√ÅC NH·∫¨N UPLOAD ========= --}}
<div class="modal fade" id="confirmUploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-youtube text-danger me-2"></i>Upload YouTube?
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        B·∫°n mu·ªën upload&nbsp;<strong id="up-video-title"></strong>&nbsp;l√™n YouTube?
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
        <button class="btn btn-danger" id="confirm-upload-btn">
          <i class="bi bi-cloud-upload"></i> Upload
        </button>
      </div>
    </div>
  </div>
</div>

{{!-- ========= TOAST TH√îNG B√ÅO ========= --}}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toastMsg" class="toast text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div id="toast-body" class="toast-body"></div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{{!-- ========== SCRIPTS ========== --}}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  /* ------------------ Modal & Toast ------------------ */
  const deleteModal  = new bootstrap.Modal('#confirmDeleteModal');
  const uploadModal  = new bootstrap.Modal('#confirmUploadModal');

  const toastEl   = document.getElementById('toastMsg');
  const toastBody = document.getElementById('toast-body');
  const toast     = new bootstrap.Toast(toastEl,{delay:3000});

  let delTargetCard, delId;
  let upBtn, upId, upUrl, upTitle;

  function showToast(msg,type='success'){
    toastEl.classList.remove('bg-success','bg-danger','bg-info');
    toastEl.classList.add(`bg-${type}`);
    toastBody.textContent = msg;
    toast.show();
  }

  /* ===== XO√Å VIDEO ===== */
  document.querySelectorAll('.btn-del').forEach(btn => {
    btn.addEventListener('click', () => {
      delId         = btn.dataset.id;
      delTargetCard = btn.closest('[class*="col-"]');
      const title   = delTargetCard.querySelector('h6').textContent.trim();
      document.getElementById('del-video-title').textContent = `"${title}"`;
      deleteModal.show();
    });
  });

  document.getElementById('confirm-delete-btn').addEventListener('click', async e => {
    const btn = e.currentTarget;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ƒêang xo√°...';

    try{
      const res = await fetch('/api/videos/'+delId,{method:'DELETE'});
      const js  = await res.json();
      if(js.success){
        delTargetCard.remove();
        showToast('ƒê√£ xo√° video th√†nh c√¥ng ‚úîÔ∏è','success');
      }else{
        showToast(js.error||'Xo√° th·∫•t b·∫°i!','danger');
      }
    }catch(err){
      console.error(err);
      showToast('L·ªói m·∫°ng ‚Äì th·ª≠ l·∫°i!','danger');
    }finally{
      btn.disabled=false;
      btn.innerHTML='<i class="bi bi-trash"></i> Xo√°';
      deleteModal.hide();
    }
  });

  /* ===== UPLOAD YOUTUBE ===== */
  document.querySelectorAll('.btn-youtube').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      upBtn   = btn;
      upId    = btn.dataset.id;
      upUrl   = btn.dataset.url;
      upTitle = btn.dataset.title;

      if(!upUrl){ showToast('Thi·∫øu ƒë∆∞·ªùng d·∫´n video.','danger'); return; }

      document.getElementById('up-video-title').textContent = `"${upTitle}"`;
      uploadModal.show();
    });
  });

  document.getElementById('confirm-upload-btn').addEventListener('click', async e=>{
    const btn = e.currentTarget;
    btn.disabled=true;
    btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>ƒêang upload...';

    try{
      const res = await fetch(`/api/videos/${upId}/upload-youtube`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify({url:upUrl,title:upTitle})
      });
      const txt = await res.text();
      let js;
      try{ js=JSON.parse(txt);}catch(err){
        console.error('Server tr·∫£ v·ªÅ:',txt);
        showToast('Server tr·∫£ v·ªÅ d·ªØ li·ªáu l·∫°!','danger');
        return;
      }

      if(js.success){
        /* ƒë·ªïi n√∫t th√†nh ‚Äúƒê√£ upload‚Äù */
        upBtn.classList.remove('btn-outline-sky');
        upBtn.classList.add('btn-secondary');
        upBtn.innerHTML='<i class="bi bi-check-circle-fill me-1"></i> ƒê√£ upload';
        upBtn.disabled=true;

        showToast('Upload YouTube th√†nh c√¥ng!','success');
      }else{
        showToast(js.error||'Upload th·∫•t b·∫°i!','danger');
      }

    }catch(err){
      console.error(err);
      showToast('Upload l·ªói ‚Äì xem console.','danger');
    }finally{
      btn.disabled=false;
      btn.innerHTML='<i class="bi bi-cloud-upload"></i> Upload';
      uploadModal.hide();
    }
  });
})();
</script>

{{!-- (Tu·ª≥ m·ª•c ƒë√≠ch, c√≥ th·ªÉ b·ªè block player b√™n d∆∞·ªõi) --}}
<video id="video-player" controls hidden>
  <source src="{{video.publish_url}}" type="video/mp4">
</video>

<script>
const vp=document.getElementById('video-player');
vp?.addEventListener('ended',()=>fetch('/api/video-statistics/complete',{
  method:'POST',headers:{'Content-Type':'application/json'},
  body:JSON.stringify({videoId:{{video.id}},durationWatched:Math.floor(vp.duration),isCompleted:true})
}));
</script>
